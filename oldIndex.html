<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Canvas tutorial</title>
  <!-- 
    <script src='FileSaver.js'></script>
	-->
  <script type="text/javascript">
    
		// Assume points within x(-180,180) and y(-240,240)
      points=[]
      line = []
      slopeEquation=""
      xmax=0
      ymax=0
      radius = 4
      function draw() {
        var canvas = document.getElementById('tutorial');
        xmax=canvas.width/2
        ymax=canvas.height/2
        console.log("Xmax=",xmax," Ymax=",ymax)
        if (canvas.getContext) {
          var ctx = canvas.getContext('2d');
          ctx.clearRect(0,0,canvas.width,canvas.height);
          // Draw the X-axis and Y-axis
          ctx.fillRect(0,ymax,xmax*2,2) // X-Axis
          ctx.fillRect(xmax,0,2,ymax*2) // Y-Axis
          // Draw the points
          points.forEach(function(item){
            ctx.moveTo(xmax+item[0],ymax-item[1])
            ctx.arc(xmax+item[0],ymax-item[1],radius,0,2*Math.PI,true)
            ctx.fillStyle="darkblue";
            ctx.fill();
          })
          // Draw the regression line
          ctx.beginPath();
          ctx.lineWidth=2
          ctx.moveTo(xmax+line[0], ymax-line[1]);
          ctx.lineTo(xmax+line[2], ymax-line[3]);
          ctx.strokeStyle = 'red';
          ctx.stroke();
          ctx.closePath();
          ctx.fill();
          // Write the equation
          ctx.font = "30px Arial";
          ctx.fillText(slopeEquation, xmax,30);
          // Write the number line
          ctx.font = "8px Arial";
          ctx.fillStyle="grey";
          for(i=0;i<ymax*2;i=i+25) {
            ctx.fillText(ymax-i,xmax+3,i)
            ctx.fillRect(i,0,1,ymax*2)
          }
          for(i=0;i<xmax*2;i=i+25) {
            ctx.fillText(i-xmax,i,ymax-3)
            ctx.fillRect(0,i,xmax*2,1)
          }
        }

      }

      function acceptInput() {
        var canvas = document.getElementById('tutorial');
        function getCursorPosition(canvas, event) {
          const rect = canvas.getBoundingClientRect()
          const x = event.clientX - rect.left
          const y = event.clientY - rect.top
          newPoint=[x-xmax,ymax-y]
          if(points.indexOf(newPoint)== -1) {
            points.push([x-xmax,ymax-y])
          }
          console.log("x: " + x + " y: " + y);
          console.log("points=",points);
          findLineByLeastSquares();
          draw()
          }
        canvas.addEventListener('mousedown', function(e) {
          getCursorPosition(canvas, e)
        })
      }

      function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        //document.body.removeChild(element);
      }

      function downloadData() {
        console.log("Called: downloadData")
        var fileContents="x,y"
        points.forEach(function(item){
          fileContents+='\n'
          fileContents+=item[0];
          fileContents+=',';
          fileContents+=item[1];
          })
        //download("hello2.txt","This is the NEW content of my file :)");
        download("points.csv",fileContents);
        console.log("Finished: downloadData:\n",fileContents)
      }

      function findLineByLeastSquares() {
        var x_sum = 0;
        var y_sum = 0;
        var xy_sum = 0;
        var xx_sum = 0;
        var count = 0;

        if (points.length <= 1) {
          console.log("Not enough points found")
          return;
        }

        /* TO-DO
         * Handle the special case where all items are in one line (x=c)
         */

        points.forEach(function(item){
          x_sum+=item[0];
          y_sum+=item[1];
          xx_sum+=item[0]*item[0];
          xy_sum+=item[0]*item[1];
          count++;
          })

        /*
         * Calculate m and b for the line equation:
         * y = x * m + b
         */
        var m = (count*xy_sum - x_sum*y_sum) / (count*xx_sum - x_sum*x_sum);
        var b = (y_sum/count) - (m*x_sum)/count;
        var y1 = m*(-xmax) + b;
        var y2 = m*(xmax) + b;
        console.log("Count=",count," XY-sum=",xy_sum," X-sum=",x_sum," XX-sum=",xx_sum)
        console.log("Slope-intercept:",m,b,"Points:[-180,",y1,"] and [180,",y2,"]");
        line=[-xmax,y1,xmax,y2];
        if(b>=0) {
          slopeEquation=" y = "+m.toFixed(2)+"x + "+b.toFixed(2)
        } else {
          c=-b
          slopeEquation=" y = "+m.toFixed(2)+"x - "+c.toFixed(2)
        }
        console.log("Slope equation=",slopeEquation)
        draw();
      }
	</script>
	<style type="text/css">
		canvas {
			border: 2px solid black;
		}
	</style>
</head>

<body onload="draw();acceptInput();">
	<canvas id="tutorial" width="500" height="500"></canvas>
  <p>
  <button type="button" onclick="downloadData()">Download</button>
  
</body>

</html>

</html>